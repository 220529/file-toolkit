# 技术选型文档

## 一、需求分析

### 1.1 功能需求

| 功能 | 描述 | 技术要求 |
|------|------|---------|
| 文件统计 | 递归扫描文件夹，统计各类型文件数量/大小 | 高性能文件遍历 |
| 文件去重 | 基于 MD5 检测重复文件，用户确认后删除 | 大文件哈希计算 |
| 视频截取 | 指定时间段截取视频片段 | FFmpeg 集成 |
| 视频超分 | AI 还原视频清晰度 | GPU 加速 / 云端 API |

### 1.2 非功能需求

| 需求 | 说明 |
|------|------|
| 跨平台 | 支持 macOS、Windows |
| 性能 | 扫描万级文件 < 5s，大文件 MD5 计算流畅 |
| 体验 | 原生应用体验，支持拖拽 |
| 包体积 | 尽量小，便于分发 |
| 离线可用 | 核心功能不依赖网络 |

## 二、桌面框架选型

### 2.1 候选方案

| 方案 | 技术栈 | 包体积 | 性能 | 开发成本 |
|------|--------|--------|------|---------|
| Electron | Node.js + Chromium | 150MB+ | 中 | 低 |
| Tauri | Rust + 系统 WebView | 5-15MB | 高 | 中 |
| Wails | Go + 系统 WebView | 10-20MB | 高 | 中 |
| Flutter | Dart | 20-30MB | 高 | 中 |
| Qt | C++ | 30-50MB | 高 | 高 |

### 2.2 详细对比

#### Electron
```
优点：
✅ 生态成熟，npm 包丰富
✅ 开发门槛低，纯 JS/TS
✅ 调试体验好（Chrome DevTools）
✅ 大量成功案例（VS Code、Slack、Discord）

缺点：
❌ 包体积大（内置 Chromium ~120MB）
❌ 内存占用高（200MB+）
❌ 启动速度慢
❌ 文件操作性能一般
```

#### Tauri
```
优点：
✅ 包体积小（5-15MB）
✅ 内存占用低（~50MB）
✅ Rust 后端性能极高
✅ 安全性好（默认最小权限）
✅ 启动速度快

缺点：
❌ 需要学习 Rust
❌ 生态相对较新
❌ 不同平台 WebView 可能有差异
```

#### Wails
```
优点：
✅ Go 语言，比 Rust 易学
✅ 包体积小
✅ 性能好

缺点：
❌ 生态较小
❌ 社区活跃度不如 Tauri
```

### 2.3 最终选择：Tauri

**选择理由**：

1. **性能需求**：文件扫描、MD5 计算是 CPU 密集型操作，Rust 性能远超 Node.js
   ```
   测试：扫描 10000 个文件
   - Node.js (fs.readdir): ~3.2s
   - Rust (walkdir): ~0.4s
   
   测试：计算 1GB 文件 MD5
   - Node.js (crypto): ~4.5s
   - Rust (md5): ~1.8s
   ```

2. **包体积**：工具类应用，用户期望轻量
   - Electron: 150MB+
   - Tauri: 10MB 左右

3. **用户体验**：启动快、内存占用低

4. **安全性**：Tauri 默认最小权限，适合文件操作类应用

## 三、前端技术选型

### 3.1 框架选择

| 方案 | 说明 | 选择 |
|------|------|------|
| React | 生态丰富，组件化 | ✅ 选用 |
| Vue | 易上手，模板语法 | 备选 |
| Svelte | 编译时框架，包小 | 备选 |
| Solid | 性能好，类 React | 备选 |

**选择 React 理由**：
- 生态最丰富
- TypeScript 支持好
- 团队熟悉度高

### 3.2 样式方案

| 方案 | 说明 | 选择 |
|------|------|------|
| TailwindCSS | 原子化 CSS，开发快 | ✅ 选用 |
| CSS Modules | 模块化，无冲突 | 备选 |
| styled-components | CSS-in-JS | 不选（运行时开销） |

### 3.3 状态管理

| 方案 | 说明 | 选择 |
|------|------|------|
| React useState/useContext | 简单场景够用 | ✅ 选用 |
| Zustand | 轻量，API 简洁 | 复杂时引入 |
| Redux | 重，本项目不需要 | 不选 |

### 3.4 构建工具

| 方案 | 说明 | 选择 |
|------|------|------|
| Vite | 快，Tauri 官方推荐 | ✅ 选用 |
| Webpack | 成熟但慢 | 不选 |

## 四、后端技术选型

### 4.1 语言选择

Tauri 后端必须用 Rust，这也是选择 Tauri 的原因之一。

**Rust 优势**：
- 零成本抽象，性能接近 C/C++
- 内存安全，无 GC 停顿
- 强类型系统，编译期发现错误
- 优秀的并发支持

### 4.2 核心依赖

| 功能 | Crate | 说明 |
|------|-------|------|
| 目录遍历 | walkdir | 递归遍历，性能好 |
| MD5 计算 | md-5 | 纯 Rust 实现 |
| 序列化 | serde | JSON 序列化 |
| 异步运行时 | tokio | 异步 IO |
| 进程调用 | std::process | 调用 FFmpeg |

### 4.3 视频处理方案

#### FFmpeg 集成

| 方案 | 说明 | 选择 |
|------|------|------|
| 内置二进制 | 打包 FFmpeg 到应用 | ✅ 选用 |
| 系统调用 | 依赖用户安装 | 备选 |
| ffmpeg-next | Rust FFmpeg 绑定 | 不选（编译复杂） |

**选择内置二进制理由**：
- 开箱即用，用户无需安装
- 版本可控，避免兼容问题
- 缺点是包体积增加 ~80MB

#### AI 超分方案

| 方案 | 说明 | 选择 |
|------|------|------|
| Real-ESRGAN 本地 | 开源，需要 GPU | ✅ 主方案 |
| 云端 API | 无需 GPU，按量付费 | 备选 |

## 五、数据存储

### 5.1 配置存储

使用系统标准路径：
- macOS: `~/Library/Application Support/file-toolkit/`
- Windows: `%APPDATA%/file-toolkit/`

存储格式：JSON

### 5.2 临时文件

视频处理需要临时目录：
- 使用系统临时目录 `std::env::temp_dir()`
- 处理完成后清理

## 六、安全设计

### 6.1 权限控制

Tauri 采用最小权限原则：

```json
// tauri.conf.json
{
  "app": {
    "security": {
      "capabilities": [
        {
          "identifier": "main",
          "permissions": [
            "dialog:allow-open",
            "dialog:allow-save",
            "fs:allow-read",
            "fs:allow-write",
            "shell:allow-execute"
          ]
        }
      ]
    }
  }
}
```

### 6.2 文件操作安全

- 删除操作必须用户确认
- 提供"移动到回收站"选项
- 记录操作日志

## 七、跨平台兼容

### 7.1 文件路径

```rust
// 使用 std::path::Path，自动处理路径分隔符
use std::path::Path;

let path = Path::new(&user_input);
```

### 7.2 外部程序

```rust
// 根据平台选择可执行文件
#[cfg(target_os = "windows")]
const FFMPEG: &str = "ffmpeg.exe";

#[cfg(not(target_os = "windows"))]
const FFMPEG: &str = "ffmpeg";
```

### 7.3 WebView 差异

| 平台 | WebView | 注意事项 |
|------|---------|---------|
| macOS | WebKit | 兼容性好 |
| Windows | WebView2 (Edge) | 需要 WebView2 运行时 |
| Linux | WebKitGTK | 需要安装依赖 |

## 八、技术风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| Rust 学习曲线 | 开发效率 | 核心逻辑用 Rust，简单逻辑可用前端 |
| WebView 兼容性 | UI 表现不一致 | 使用标准 CSS，充分测试 |
| FFmpeg 体积大 | 包体积增加 | 可提供精简版，或让用户自行安装 |
| AI 超分性能 | 无 GPU 时很慢 | 提供云端 API 备选方案 |

## 九、技术栈总结

```
┌─────────────────────────────────────────┐
│              File Toolkit               │
├─────────────────────────────────────────┤
│  前端                                    │
│  ├── React 18                           │
│  ├── TypeScript 5                       │
│  ├── TailwindCSS 3                      │
│  ├── Vite 5                             │
│  └── @tauri-apps/api                    │
├─────────────────────────────────────────┤
│  后端 (Rust)                            │
│  ├── Tauri 2.0                          │
│  ├── walkdir (目录遍历)                  │
│  ├── md-5 (哈希计算)                     │
│  ├── serde (序列化)                      │
│  └── tokio (异步)                        │
├─────────────────────────────────────────┤
│  外部依赖                                │
│  ├── FFmpeg (视频处理)                   │
│  └── Real-ESRGAN (AI 超分)              │
└─────────────────────────────────────────┘
```
