# 架构设计文档

## 一、系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         File Toolkit                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                    前端层 (WebView)                         │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │ │
│  │  │ 文件统计  │ │ 文件去重  │ │ 视频截取  │ │ 视频超分  │      │ │
│  │  │   Page   │ │   Page   │ │   Page   │ │   Page   │      │ │
│  │  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘      │ │
│  │       │            │            │            │             │ │
│  │  ┌────▼────────────▼────────────▼────────────▼─────┐      │ │
│  │  │              Tauri IPC Bridge                    │      │ │
│  │  │         @tauri-apps/api/core.invoke()           │      │ │
│  │  └────────────────────┬────────────────────────────┘      │ │
│  └───────────────────────┼────────────────────────────────────┘ │
│                          │                                       │
│  ┌───────────────────────▼────────────────────────────────────┐ │
│  │                    后端层 (Rust)                            │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │                 Command Handler                       │  │ │
│  │  │  scan_directory | find_duplicates | cut_video | ...  │  │ │
│  │  └──────────┬───────────────┬───────────────┬───────────┘  │ │
│  │             │               │               │               │ │
│  │  ┌──────────▼─────┐ ┌──────▼──────┐ ┌──────▼──────┐       │ │
│  │  │   File System  │ │   FFmpeg    │ │ Real-ESRGAN │       │ │
│  │  │    walkdir     │ │   Process   │ │   Process   │       │ │
│  │  │    md5 hash    │ │             │ │             │       │ │
│  │  └────────────────┘ └─────────────┘ └─────────────┘       │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        操作系统                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  文件系统     │  │   进程管理    │  │   GPU (可选)  │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

## 二、模块设计

### 2.1 前端模块

```
src/
├── components/           # 可复用组件
│   ├── DropZone.tsx     # 拖拽上传区域
│   ├── FileTable.tsx    # 文件列表表格
│   ├── ProgressBar.tsx  # 进度条
│   ├── Modal.tsx        # 模态框
│   └── TimeInput.tsx    # 时间输入组件
├── pages/               # 页面组件
│   ├── FileStats.tsx    # 文件统计页
│   ├── Dedup.tsx        # 去重页
│   ├── VideoCut.tsx     # 视频截取页
│   └── VideoUpscale.tsx # 视频超分页
├── hooks/               # 自定义 Hooks
│   ├── useTauriCommand.ts    # 封装 invoke
│   └── useTauriEvent.ts      # 封装 listen
├── stores/              # 状态管理（可选）
│   └── appStore.ts
└── utils/               # 工具函数
    ├── format.ts        # 格式化
    └── validate.ts      # 校验
```

### 2.2 后端模块

```
src-tauri/src/
├── commands/            # Tauri 命令
│   ├── mod.rs          # 模块导出
│   ├── file_stats.rs   # 文件统计
│   ├── dedup.rs        # 文件去重
│   ├── video_cut.rs    # 视频截取
│   └── video_upscale.rs # 视频超分
├── utils/               # 工具模块
│   ├── mod.rs
│   ├── ffmpeg.rs       # FFmpeg 封装
│   └── hash.rs         # 哈希计算
├── lib.rs              # 库入口
└── main.rs             # 主入口
```

## 三、数据流设计

### 3.1 文件统计流程

```
用户点击"选择文件夹"
        │
        ▼
┌───────────────────┐
│  open() 对话框     │  ← @tauri-apps/plugin-dialog
└─────────┬─────────┘
          │ 返回路径
          ▼
┌───────────────────┐
│ invoke('scan_    │
│  directory')      │  ← 前端调用
└─────────┬─────────┘
          │ IPC
          ▼
┌───────────────────┐
│ Rust: WalkDir     │  ← 递归遍历
│ 遍历所有文件       │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 统计各扩展名       │
│ 数量和大小         │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 返回 Vec<Stats>   │
└─────────┬─────────┘
          │ IPC
          ▼
┌───────────────────┐
│ 前端渲染表格       │
└───────────────────┘
```

### 3.2 文件去重流程

```
用户选择文件夹
        │
        ▼
┌───────────────────┐
│ invoke('find_    │
│  duplicates')     │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 1. 按文件大小分组  │  ← 快速筛选
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 2. 大小相同的      │
│    计算 MD5       │  ← 精确匹配
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 3. 返回重复组      │
│    DuplicateGroup │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 前端展示重复文件   │
│ 用户勾选要删除的   │
└─────────┬─────────┘
          │ 用户确认
          ▼
┌───────────────────┐
│ invoke('delete_  │
│  files')          │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Rust: fs::remove │
│ 删除选中文件       │
└───────────────────┘
```

### 3.3 视频处理流程

```
用户选择视频 + 设置参数
        │
        ▼
┌───────────────────┐
│ invoke('cut_video'│
│  / 'upscale_..') │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Rust: 构建 FFmpeg │
│ 命令行参数         │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Command::new()   │
│ 执行 FFmpeg       │
└─────────┬─────────┘
          │ 进度事件
          ▼
┌───────────────────┐
│ window.emit()    │  ← 发送进度到前端
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ 前端更新进度条     │
└─────────┬─────────┘
          │ 完成
          ▼
┌───────────────────┐
│ 返回输出文件路径   │
└───────────────────┘
```

## 四、接口设计

### 4.1 Tauri Commands

| 命令 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `scan_directory` | `path: String` | `Vec<FileStats>` | 扫描目录统计 |
| `find_duplicates` | `path: String` | `Vec<DuplicateGroup>` | 查找重复文件 |
| `delete_files` | `paths: Vec<String>` | `u32` | 删除文件 |
| `cut_video` | `input, output, start, end` | `String` | 截取视频 |
| `get_video_duration` | `path: String` | `f64` | 获取视频时长 |
| `upscale_video` | `input, output, scale` | `String` | 视频超分 |

### 4.2 Tauri Events

| 事件名 | Payload | 说明 |
|--------|---------|------|
| `scan_progress` | `f64` (0-1) | 扫描进度 |
| `upscale_progress` | `String` | 超分处理阶段 |
| `ffmpeg_progress` | `f64` (0-1) | FFmpeg 处理进度 |

### 4.3 数据结构

```typescript
// 文件统计
interface FileStats {
  extension: string;
  count: number;
  total_size: number;
}

// 文件信息
interface FileInfo {
  path: string;
  name: string;
  size: number;
  modified: number;
}

// 重复文件组
interface DuplicateGroup {
  hash: string;
  size: number;
  files: FileInfo[];
}
```

## 五、错误处理

### 5.1 Rust 端

所有命令返回 `Result<T, String>`，错误信息会传递到前端：

```rust
#[tauri::command]
pub fn some_command() -> Result<Data, String> {
    do_something().map_err(|e| format!("操作失败: {}", e))?;
    Ok(data)
}
```

### 5.2 前端

统一错误处理：

```typescript
async function safeInvoke<T>(cmd: string, args?: object): Promise<T | null> {
  try {
    return await invoke<T>(cmd, args);
  } catch (e) {
    console.error(`Command ${cmd} failed:`, e);
    toast.error(String(e));
    return null;
  }
}
```

## 六、安全考虑

### 6.1 文件访问权限

Tauri 默认限制文件访问范围，需要在配置中声明：

```json
// tauri.conf.json
{
  "app": {
    "security": {
      "capabilities": [
        {
          "identifier": "default",
          "permissions": [
            "dialog:default",
            "fs:default"
          ]
        }
      ]
    }
  }
}
```

### 6.2 删除操作保护

- 删除前必须用户确认
- 记录删除日志
- 考虑移动到回收站而非直接删除

```rust
// 可选：移动到回收站
use trash;

pub fn safe_delete(path: &str) -> Result<(), String> {
    trash::delete(path).map_err(|e| e.to_string())
}
```

## 七、性能指标

| 操作 | 目标性能 | 说明 |
|------|---------|------|
| 扫描 10000 文件 | < 2s | 纯遍历，不计算哈希 |
| MD5 计算 1GB 文件 | < 3s | 流式读取 |
| 视频截取 | 实时 | 使用 -c copy 无损截取 |
| 视频超分 1分钟 | 10-30分钟 | 取决于 GPU |

## 八、扩展性设计

### 8.1 插件化架构（未来）

```
plugins/
├── image-compress/      # 图片压缩插件
├── batch-rename/        # 批量重命名插件
└── cloud-sync/          # 云同步插件
```

### 8.2 配置系统

```typescript
// 用户配置
interface AppConfig {
  theme: 'light' | 'dark';
  ffmpegPath?: string;      // 自定义 FFmpeg 路径
  defaultOutputDir?: string; // 默认输出目录
  deleteToTrash: boolean;    // 删除到回收站
}
```

配置存储在用户目录：
- macOS: `~/Library/Application Support/file-toolkit/config.json`
- Windows: `%APPDATA%/file-toolkit/config.json`
