# 开发指南

## 一、环境搭建

### 1.1 安装 Rust

```bash
# macOS / Linux
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# Windows
# 下载 https://rustup.rs 安装程序

# 验证安装
rustc --version
cargo --version
```

### 1.2 安装 Node.js

推荐使用 nvm 管理 Node 版本：

```bash
# 安装 nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 安装 Node.js 18
nvm install 18
nvm use 18

# 安装 pnpm
npm install -g pnpm
```

### 1.3 安装 Tauri CLI

```bash
# 通过 Cargo 安装
cargo install tauri-cli

# 或通过 npm 安装
pnpm add -D @tauri-apps/cli
```

### 1.4 系统依赖

**macOS:**
```bash
xcode-select --install
```

**Windows:**
- 安装 [Visual Studio Build Tools](https://visualstudio.microsoft.com/visual-cpp-build-tools/)
- 安装 [WebView2](https://developer.microsoft.com/en-us/microsoft-edge/webview2/)

**Linux (Ubuntu/Debian):**
```bash
sudo apt update
sudo apt install libwebkit2gtk-4.1-dev build-essential curl wget file \
  libssl-dev libayatana-appindicator3-dev librsvg2-dev
```

### 1.5 安装 FFmpeg

**macOS:**
```bash
brew install ffmpeg
```

**Windows:**
下载 [FFmpeg](https://ffmpeg.org/download.html) 并添加到 PATH

**Linux:**
```bash
sudo apt install ffmpeg
```

## 二、项目初始化

### 2.1 创建项目

```bash
# 使用 Tauri 官方模板
pnpm create tauri-app file-toolkit --template react-ts

cd file-toolkit

# 安装依赖
pnpm install
```

### 2.2 安装额外依赖

```bash
# 前端依赖
pnpm add react-router-dom
pnpm add -D tailwindcss postcss autoprefixer
pnpm add @tauri-apps/api

# 初始化 Tailwind
npx tailwindcss init -p
```

### 2.3 Rust 依赖

编辑 `src-tauri/Cargo.toml`:

```toml
[dependencies]
tauri = { version = "2", features = ["shell-open"] }
serde = { version = "1", features = ["derive"] }
serde_json = "1"
walkdir = "2"           # 递归遍历目录
md-5 = "0.10"           # MD5 计算
tokio = { version = "1", features = ["full"] }  # 异步运行时
```

## 三、核心模块开发

### 3.1 文件统计模块

**Rust 实现** (`src-tauri/src/commands/file_stats.rs`):

```rust
use serde::Serialize;
use std::collections::HashMap;
use walkdir::WalkDir;

#[derive(Serialize)]
pub struct FileStats {
    pub extension: String,
    pub count: u64,
    pub total_size: u64,
}

#[tauri::command]
pub fn scan_directory(path: String) -> Result<Vec<FileStats>, String> {
    let mut stats: HashMap<String, (u64, u64)> = HashMap::new();

    for entry in WalkDir::new(&path)
        .into_iter()
        .filter_map(|e| e.ok())
        .filter(|e| e.file_type().is_file())
    {
        let ext = entry
            .path()
            .extension()
            .map(|e| e.to_string_lossy().to_lowercase())
            .unwrap_or_default();

        let size = entry.metadata().map(|m| m.len()).unwrap_or(0);

        let stat = stats.entry(ext).or_insert((0, 0));
        stat.0 += 1;
        stat.1 += size;
    }

    let mut result: Vec<FileStats> = stats
        .into_iter()
        .map(|(ext, (count, size))| FileStats {
            extension: if ext.is_empty() {
                "(无扩展名)".into()
            } else {
                format!(".{}", ext)
            },
            count,
            total_size: size,
        })
        .collect();

    result.sort_by(|a, b| b.count.cmp(&a.count));
    Ok(result)
}
```

**前端调用** (`src/pages/FileStats.tsx`):

```tsx
import { useState } from 'react';
import { invoke } from '@tauri-apps/api/core';
import { open } from '@tauri-apps/plugin-dialog';

interface FileStats {
  extension: string;
  count: number;
  total_size: number;
}

export default function FileStats() {
  const [stats, setStats] = useState<FileStats[]>([]);
  const [loading, setLoading] = useState(false);

  async function handleScan() {
    const selected = await open({ directory: true });
    if (!selected) return;

    setLoading(true);
    try {
      const result = await invoke<FileStats[]>('scan_directory', {
        path: selected,
      });
      setStats(result);
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="p-4">
      <button
        onClick={handleScan}
        disabled={loading}
        className="px-4 py-2 bg-blue-500 text-white rounded"
      >
        {loading ? '扫描中...' : '选择文件夹'}
      </button>

      {stats.length > 0 && (
        <table className="mt-4 w-full">
          <thead>
            <tr>
              <th>类型</th>
              <th>数量</th>
              <th>大小</th>
            </tr>
          </thead>
          <tbody>
            {stats.map((s) => (
              <tr key={s.extension}>
                <td>{s.extension}</td>
                <td>{s.count}</td>
                <td>{formatSize(s.total_size)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      )}
    </div>
  );
}

function formatSize(bytes: number): string {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(1) + ' MB';
  return (bytes / 1024 / 1024 / 1024).toFixed(2) + ' GB';
}
```

### 3.2 注册 Tauri 命令

编辑 `src-tauri/src/lib.rs`:

```rust
mod commands;

use commands::file_stats::scan_directory;
use commands::dedup::{find_duplicates, delete_files};
use commands::video_cut::{cut_video, get_video_duration};
use commands::video_upscale::upscale_video;

#[cfg_attr(mobile, tauri::mobile_entry_point)]
pub fn run() {
    tauri::Builder::default()
        .plugin(tauri_plugin_dialog::init())
        .plugin(tauri_plugin_shell::init())
        .invoke_handler(tauri::generate_handler![
            scan_directory,
            find_duplicates,
            delete_files,
            cut_video,
            get_video_duration,
            upscale_video,
        ])
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

## 四、FFmpeg 集成

### 4.1 内置 FFmpeg 二进制

下载各平台 FFmpeg 静态编译版本：
- macOS: https://evermeet.cx/ffmpeg/
- Windows: https://www.gyan.dev/ffmpeg/builds/
- Linux: https://johnvansickle.com/ffmpeg/

放置到 `src-tauri/resources/` 目录。

### 4.2 Tauri 资源配置

编辑 `src-tauri/tauri.conf.json`:

```json
{
  "bundle": {
    "resources": [
      "resources/*"
    ]
  }
}
```

### 4.3 运行时获取 FFmpeg 路径

```rust
use tauri::Manager;

fn get_ffmpeg_path(app: &tauri::AppHandle) -> String {
    let resource_path = app
        .path()
        .resource_dir()
        .expect("failed to get resource dir");

    #[cfg(target_os = "windows")]
    let ffmpeg = resource_path.join("ffmpeg.exe");

    #[cfg(target_os = "macos")]
    let ffmpeg = resource_path.join("ffmpeg-mac");

    #[cfg(target_os = "linux")]
    let ffmpeg = resource_path.join("ffmpeg-linux");

    ffmpeg.to_string_lossy().to_string()
}
```

## 五、调试技巧

### 5.1 前端调试

开发模式下自动打开 DevTools：

```json
// src-tauri/tauri.conf.json
{
  "app": {
    "windows": [
      {
        "title": "File Toolkit",
        "width": 1000,
        "height": 700
      }
    ]
  }
}
```

按 `Cmd+Shift+I` (Mac) 或 `Ctrl+Shift+I` (Windows) 打开 DevTools。

### 5.2 Rust 调试

```bash
# 查看 Rust 日志
RUST_LOG=debug pnpm tauri dev

# 在 Rust 代码中打印
println!("Debug: {:?}", some_value);
```

### 5.3 常见问题

**Q: 命令调用返回 undefined**
A: 检查 Rust 函数是否正确返回 `Result<T, String>`

**Q: 文件对话框不弹出**
A: 确保安装了 `@tauri-apps/plugin-dialog` 并在 Rust 端注册

**Q: FFmpeg 找不到**
A: 检查资源文件是否正确打包，路径是否正确

## 六、构建发布

### 6.1 构建命令

```bash
# 开发构建
pnpm tauri build --debug

# 生产构建
pnpm tauri build
```

### 6.2 产物位置

```
src-tauri/target/release/bundle/
├── dmg/                    # macOS DMG
├── macos/                  # macOS App
├── msi/                    # Windows MSI
├── nsis/                   # Windows NSIS
└── deb/                    # Linux DEB
```

### 6.3 CI/CD 配置

`.github/workflows/release.yml`:

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    strategy:
      matrix:
        platform: [macos-latest, windows-latest, ubuntu-22.04]

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Rust
        uses: dtolnay/rust-action@stable

      - name: Install dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libayatana-appindicator3-dev

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm tauri build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-bundle
          path: src-tauri/target/release/bundle/
```

## 七、性能优化

### 7.1 大文件 MD5 优化

使用流式读取，避免一次性加载整个文件：

```rust
fn calculate_md5(path: &Path) -> Result<String, String> {
    let mut file = File::open(path).map_err(|e| e.to_string())?;
    let mut hasher = Md5::new();
    let mut buffer = [0u8; 65536]; // 64KB buffer

    loop {
        let bytes_read = file.read(&mut buffer).map_err(|e| e.to_string())?;
        if bytes_read == 0 { break; }
        hasher.update(&buffer[..bytes_read]);
    }

    Ok(format!("{:x}", hasher.finalize()))
}
```

### 7.2 并行处理

使用 Rayon 并行计算多个文件的 MD5：

```rust
use rayon::prelude::*;

let hashes: Vec<_> = files
    .par_iter()
    .map(|f| calculate_md5(f))
    .collect();
```

### 7.3 进度回调

使用 Tauri 事件系统向前端发送进度：

```rust
#[tauri::command]
pub async fn scan_with_progress(
    path: String,
    window: tauri::Window,
) -> Result<Vec<FileStats>, String> {
    let total = count_files(&path);
    let mut processed = 0;

    for entry in WalkDir::new(&path) {
        // 处理文件...
        processed += 1;

        // 每处理 100 个文件发送一次进度
        if processed % 100 == 0 {
            window.emit("scan_progress", processed as f64 / total as f64).ok();
        }
    }

    Ok(result)
}
```

前端监听：

```typescript
import { listen } from '@tauri-apps/api/event';

useEffect(() => {
  const unlisten = listen('scan_progress', (event) => {
    setProgress(event.payload as number);
  });
  return () => { unlisten.then(fn => fn()); };
}, []);
```
